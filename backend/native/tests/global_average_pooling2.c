

#include "tests.h"
#include "nn.h"

int global_average_pooling2_random_1()
{
    int h = 5;
    int w = 5;
    int channels = 3;

    float inputs[] = {-0.306, 0.473, 0.398, -0.481, -0.647, 0.211, 0.441, 0.255, -0.854, 0.184, 0.513, 0.297, -0.967, -0.981, -0.151, -0.0321, 0.572, 0.131, 0.698, 0.129, 0.669, 0.173, 0.233, -0.261, -0.159, 0.196, -0.989, 0.0283, -0.788, 0.432, -0.761, 0.109, -0.432, -0.0136, -0.3, -0.985, -0.17, -0.601, -0.474, -0.631, 0.244, 0.381, 0.797, -0.584, -0.0883, -0.967, 0.0139, -0.713, 0.0912, 0.123, -0.92, -0.218, -0.824, 0.463, -0.266, -0.558, -0.457, 0.0445, -0.866, -0.403, -0.277, 0.584, 0.809, 0.608, 0.876, 0.345, 0.602, 0.213, 0.551, 0.993, 0.781, -0.903, -0.525, -0.383, -0.566};
    float expected[] = {-0.0445, -0.0488, -0.14};

    float ret[channels];
    matutil_global_average_pooling_2d(inputs, h, w, channels, ret);
    return print_result("GAP2 random 1", assert_similarity(expected, ret, channels));
}

int global_average_pooling2_random_2()
{
    int h = 5;
    int w = 5;
    int channels = 3;

    float inputs[] = {-0.68, -0.356, -0.19, -0.831, 0.343, 0.497, 0.721, 0.533, 0.429, 0.62, -0.598, 0.996, -0.53, -0.968, -0.907, 0.886, 0.281, 0.772, -0.201, 0.73, 0.63, 0.676, -0.367, -0.605, 0.776, 0.289, 0.933, 0.646, 0.922, -0.0894, -0.924, -0.528, -0.481, -0.0415, -0.605, 0.351, 0.335, 0.29, 0.478, -0.489, 0.885, 0.434, -0.829, -0.532, 0.201, -0.0587, 0.241, 0.493, -0.118, -0.458, 0.377, -0.478, 0.711, 0.218, -0.644, 0.346, -0.865, -0.925, -0.357, -0.583, -0.678, 0.353, 0.937, 0.0445, -0.027, -0.602, 0.542, 0.927, 0.618, 0.648, 0.397, -0.997, -0.852, 0.747, -0.0772};
    float expected[] = {-0.0954, 0.128, 0.119};

    float ret[channels];
    matutil_global_average_pooling_2d(inputs, h, w, channels, ret);
    return print_result("GAP2 random 2", assert_similarity(expected, ret, channels));
}

int global_average_pooling2_random_3()
{
    int h = 5;
    int w = 5;
    int channels = 10;

    float inputs[] = {-0.491, 0.383, -0.627, -0.478, 0.937, -0.629, -0.621, 0.868, -0.224, 0.075, -0.239, -0.0753, -0.127, -0.353, -0.703, 0.653, -0.258, 0.0589, -0.049, -0.714, -0.0658, -0.665, -0.787, 0.91, 0.063, -0.216, -0.589, 0.788, -0.138, 0.182, -0.308, 0.735, -0.849, 0.39, 0.464, -0.487, 0.629, -0.367, -0.0648, 0.57, 0.156, 0.712, -0.0336, -0.794, 0.306, 0.279, -0.144, 0.946, 0.69, -0.917, -0.359, 0.524, 0.126, -0.564, 0.937, -0.931, 0.0282, -0.492, -0.722, 0.321, -0.452, -0.028, -0.402, 0.832, 0.277, 0.398, 0.677, -0.796, 0.587, 0.746, -0.453, -0.21, -0.091, -0.621, 0.584, -0.0148, -0.174, 0.4, 0.32, 0.24, 0.903, -0.609, -0.49, -0.701, 0.191, 0.932, 0.296, 0.379, -0.492, -0.447, 0.876, -0.993, 0.294, -0.353, 0.374, 0.678, 0.354, -0.82, 0.548, -0.79, 0.518, 0.799, 0.28, -0.621, -0.103, -0.429, -0.85, 0.414, 0.313, -0.724, -0.815, 0.0898, 0.256, -0.216, -0.0588, 0.508, 0.582, 0.876, -0.918, 0.071, -0.424, 0.797, 0.351, -0.378, -0.0179, -0.563, 0.528, 0.74, -0.806, -0.918, 0.322, 0.0736, 0.892, 0.774, -0.412, -0.664, -0.149, 0.106, -0.923, -0.61, 0.484, -0.401, -0.691, 0.53, -0.48, 0.113, -0.277, 0.713, -0.871, 0.687, 0.091, -0.525, 0.762, 0.577, 0.488, -0.172, 0.218, 0.749, 0.0681, -0.774, -0.692, -0.739, -0.000835, -0.959, -0.135, -0.843, -0.916, 0.0683, 0.536, 0.702, 0.0354, -0.593, 0.269, 0.609, -0.892, -0.775, -0.0173, 0.14, 0.979, 0.955, -0.0255, -0.385, -0.379, -0.504, 0.792, -0.858, 0.375, 0.165, -0.186, -0.0535, 0.333, -0.15, 0.751, -0.0585, -0.871, 0.377, 0.962, 0.8, 0.27, -0.385, -0.331, -0.0366, -0.823, 0.519, 0.777, 0.696, -0.481, 0.618, 0.446, -0.318, -0.558, -0.964, -0.74, -0.4, -0.563, -0.722, 0.737, -0.859, -0.724, -0.725, -0.958, 0.216, -0.0409, -0.896, -0.292, -0.0404, -0.392, -0.18, 0.27, 0.446, 0.802, 0.184, -0.905, 0.168, 0.811, 0.73, 0.785, 0.18, 0.956, 0.056, -0.606, -0.115, -0.272, -0.0191, 0.314, -0.416, 0.309, -0.031, -0.0341, 0.552};
    float expected[] = {-0.0903, -0.079, -0.131, -0.104, 0.111, -0.0959, 0.0645, 0.219, -0.0067, -0.0709};

    float ret[channels];
    matutil_global_average_pooling_2d(inputs, h, w, channels, ret);
    return print_result("GAP2 random 3", assert_similarity(expected, ret, channels));
}

void test_global_average_pooling2(int *correct_cases, int *total_cases)
{
    *correct_cases += global_average_pooling2_random_1();
    *total_cases += 1;

    *correct_cases += global_average_pooling2_random_2();
    *total_cases += 1;

    *correct_cases += global_average_pooling2_random_3();
    *total_cases += 1;
}